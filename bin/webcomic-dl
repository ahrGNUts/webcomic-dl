#!/usr/bin/python
import webcomic_dl
from webcomic_dl.comics import *
from webcomic_dl import cli, Comic
import requests
import os.path
import os
import json

def getComicClass(comic):
    for c in Comic.__subclasses__():
        if(c.match(args.comic)):
            print("using {0} downloader".format(c.__name__))
            return c


args=cli.getArgs()
print(args)

cls=getComicClass(args.comic)
dir=args.dir or cls.defaultDirname
progressFile=os.path.join(dir, ".progress")

if(args.resume and os.path.isfile(progressFile)):
    with open(progressFile, "r") as f:
        progress=json.loads(f.read())
        comic=getComicClass(args.comic)(progress["url"], progress["num"]).getNextComic()
elif(args.fromURL):
    comic=cls(args.comic)
else:
    comic=cls(cls.first)
while comic:
    print("Downloading {0}".format(comic.getImgFilename()))
    comic.downloadImg(args.dir, args.overwrite)
    comic.saveProgress(args.dir)
    comic=comic.getNextComic()
print("Done!")
